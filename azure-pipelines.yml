trigger:
  branches:
    include:
      - dev

pr:
  branches:
    include:
      - demo
      - prod

variables:
  html_filename: 'index.html'
  nginx_web_root: '/var/www/html/demo-site'
  nginx_config_path: '/etc/nginx/sites-available/demo-site'
  nginx_symlink_path: '/etc/nginx/sites-enabled/demo-site'

  # Define demand_key and demand_value based on build reason
  demand_key: $[eq(variables['Build.Reason'], 'PullRequest') ? 'branch_merge' : 'branch']
  demand_value: $[eq(variables['Build.Reason'], 'PullRequest') ? 'merge' : variables['Build.SourceBranchName']]

pool:
  name: 'Default'
  demands:
    - $[format('{0} -equals {1}', variables['demand_key'], variables['demand_value'])]

steps:
- script: echo "ðŸ” Triggered from branch: $(Build.SourceBranchName) (Reason: $(Build.Reason))"
  displayName: 'Print Source Branch and Build Reason'

- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: '**/index.html'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  displayName: 'Copy index.html from current branch'

- script: |
    echo "ðŸ“ Setting up NGINX web root at $(nginx_web_root)..."
    sudo mkdir -p $(nginx_web_root)
    sudo cp $(Build.ArtifactStagingDirectory)/$(html_filename) $(nginx_web_root)/
  displayName: 'Move HTML to NGINX root'

- script: |
    echo "âš™ï¸ Creating NGINX site config..."
    echo "server {
      listen 80;
      server_name _;

      root $(nginx_web_root);
      index index.html;

      location / {
          try_files \$uri \$uri/ =404;
      }
    }" | sudo tee $(nginx_config_path) > /dev/null
  displayName: 'Write NGINX Config File'

- script: |
    echo "ðŸ”„ Linking and restarting NGINX..."
    sudo ln -sf $(nginx_config_path) $(nginx_symlink_path)
    sudo nginx -t && sudo systemctl reload nginx
  displayName: 'Reload NGINX'
