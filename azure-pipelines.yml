trigger:
  branches:
    include:
      - dev

pr:
  branches:
    include:
      - demo
      - prod

variables:
  html_filename: 'index.html'
  nginx_web_root: '/var/www/html/demo-site'
  nginx_config_path: '/etc/nginx/sites-available/demo-site'
  nginx_symlink_path: '/etc/nginx/sites-enabled/demo-site'

jobs:
- job: PR_Build
  condition: eq(variables['Build.Reason'], 'PullRequest')
  pool:
    name: 'Default'
    demands:
      - branch_merge -equals merge
  steps:
  - script: echo "ðŸ” PR build on merge branch"
    displayName: 'Print Build Info'
  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: '**/index.html'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: 'Copy index.html from current branch'

  - script: |
      echo "ðŸ“ Setting up NGINX web root at $(nginx_web_root)..."
      sudo mkdir -p $(nginx_web_root)
      sudo cp $(Build.ArtifactStagingDirectory)/$(html_filename) $(nginx_web_root)/
    displayName: 'Move HTML to NGINX root'

  - script: |
      echo "âš™ï¸ Creating NGINX site config..."
      echo "server {
        listen 80;
        server_name _;

        root $(nginx_web_root);
        index index.html;

        location / {
            try_files \$uri \$uri/ =404;
        }
      }" | sudo tee $(nginx_config_path) > /dev/null
    displayName: 'Write NGINX Config File'

  - script: |
      echo "ðŸ”„ Linking and restarting NGINX..."
      sudo ln -sf $(nginx_config_path) $(nginx_symlink_path)
      sudo nginx -t && sudo systemctl reload nginx
    displayName: 'Reload NGINX'

- job: Branch_Build
  condition: ne(variables['Build.Reason'], 'PullRequest')
  pool:
    name: 'Default'
    demands:
      - branch -equals $(Build.SourceBranchName)
  steps:
  - script: echo "ðŸ” Branch build on $(Build.SourceBranchName)"
    displayName: 'Print Build Info'
  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: '**/index.html'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: 'Copy index.html from current branch'

  - script: |
      echo "ðŸ“ Setting up NGINX web root at $(nginx_web_root)..."
      sudo mkdir -p $(nginx_web_root)
      sudo cp $(Build.ArtifactStagingDirectory)/$(html_filename) $(nginx_web_root)/
    displayName: 'Move HTML to NGINX root'

  - script: |
      echo "âš™ï¸ Creating NGINX site config..."
      echo "server {
        listen 80;
        server_name _;

        root $(nginx_web_root);
        index index.html;

        location / {
            try_files \$uri \$uri/ =404;
        }
      }" | sudo tee $(nginx_config_path) > /dev/null
    displayName: 'Write NGINX Config File'

  - script: |
      echo "ðŸ”„ Linking and restarting NGINX..."
      sudo ln -sf $(nginx_config_path) $(nginx_symlink_path)
      sudo nginx -t && sudo systemctl reload nginx
    displayName: 'Reload NGINX'
