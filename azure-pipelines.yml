trigger:
  branches:
    include:
      - dev # Testing

pr:
  branches:
    include:
      - demo
      - prod

variables:
  html_filename: 'index.html'
  nginx_web_root: '/var/www/html/demo-site'
  nginx_config_path: '/etc/nginx/sites-available/demo-site'
  nginx_symlink_path: '/etc/nginx/sites-enabled/demo-site'

  # Normalize branch name (remove refs/heads/ and refs/pull/)
  normalizedBranch: $[replace(replace(variables['Build.SourceBranch'], 'refs/heads/', ''), 'refs/pull/', '')]

jobs:
  - job: WithDemand
    displayName: 'Run with branch demand'
    condition: ne(variables['normalizedBranch'], 'feature/demo-test')
    pool:
      name: 'Default'
      demands:
        - branch -equals $(normalizedBranch)
    steps:
      - script: echo "Running with demand for branch $(normalizedBranch)"
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)'
          Contents: '**/index.html'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'
        displayName: 'Copy index.html from current branch'

      - script: |
          echo "Setting up NGINX web root at $(nginx_web_root)..."
          sudo mkdir -p $(nginx_web_root)
          sudo cp $(Build.ArtifactStagingDirectory)/$(html_filename) $(nginx_web_root)/
        displayName: 'Move HTML to NGINX root'

      - script: |
          echo "Creating NGINX site config..."
          echo "server {
            listen 80;
            server_name _;

            root $(nginx_web_root);
            index index.html;

            location / {
                try_files \$uri \$uri/ =404;
            }
          }" | sudo tee $(nginx_config_path) > /dev/null
        displayName: 'Write NGINX Config File'

      - script: |
          echo "Linking and restarting NGINX..."
          sudo ln -sf $(nginx_config_path) $(nginx_symlink_path)
          sudo nginx -t && sudo systemctl reload nginx
        displayName: 'Reload NGINX'

  - job: WithoutDemand
    displayName: 'Run without branch demand (feature/demo-test)'
    condition: eq(variables['normalizedBranch'], 'feature/demo-test')
    pool:
      name: 'Default'
    steps:
      - script: echo "Running WITHOUT demand for branch $(normalizedBranch)"
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)'
          Contents: '**/index.html'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'
        displayName: 'Copy index.html from current branch'

      - script: |
          echo "Setting up NGINX web root at $(nginx_web_root)..."
          sudo mkdir -p $(nginx_web_root)
          sudo cp $(Build.ArtifactStagingDirectory)/$(html_filename) $(nginx_web_root)/
        displayName: 'Move HTML to NGINX root'

      - script: |
          echo "Creating NGINX site config..."
          echo "server {
            listen 80;
            server_name _;

            root $(nginx_web_root);
            index index.html;

            location / {
                try_files \$uri \$uri/ =404;
            }
          }" | sudo tee $(nginx_config_path) > /dev/null
        displayName: 'Write NGINX Config File'

      - script: |
          echo "Linking and restarting NGINX..."
          sudo ln -sf $(nginx_config_path) $(nginx_symlink_path)
          sudo nginx -t && sudo systemctl reload nginx
        displayName: 'Reload NGINX'
